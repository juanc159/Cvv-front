import{_ as ve}from"./ModalQuestion.vue_vue_type_script_setup_true_lang-D9SNDYHe.js";import{_ as ge}from"./DialogCloseBtn.vue_vue_type_script_setup_true_lang-TPY2zCiM.js";import{d as xe,ae as be,V as ye,cT as ke,cU as Ce,r as g,Y as L,c as _,b as l,f as r,ab as Z,l as u,F as U,o as c,h as x,e as a,D as i,a7 as m,y as h,af as I,G as W,a9 as y,E as v,q as ee,a8 as Se,Z as ze,$ as we}from"./index-D-B3Y6bN.js";import{V as se}from"./VDialog-BqIMSebF.js";import{V as q}from"./VCard-DOX-owg-.js";import{V as Me,a as Ve}from"./VToolbar-DxaB5-2u.js";import{V as F}from"./VCardText-CSI-zWXl.js";import{V as Fe}from"./VAlert-54lI5ZCo.js";import{V as Be}from"./VDivider-BDuFbcMr.js";import{_ as Ee}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./dialog-transition-C_MzqWLQ.js";import"./VAvatar-CgTtSMK2.js";import"./VImg-CbATnCB8.js";const b=C=>(ze("data-v-2dd52e31"),C=C(),we(),C),De={key:0,class:"upload-section"},Te={class:"dropzone-content"},$e={class:"icon-container"},Le=b(()=>a("h3",{class:"text-h5 font-weight-medium mb-2"},"Arrastra tu archivo excel aquí",-1)),Ue=b(()=>a("p",{class:"text-body-1 text-medium-emphasis mb-4"},"o selecciona desde tu computadora",-1)),Ie={class:"file-requirements mt-6"},qe={class:"d-flex align-center mb-3"},Ae=b(()=>a("h4",{class:"text-subtitle-1 font-weight-medium"},"Requisitos del archivo",-1)),Pe={class:"requirements-list"},Re={class:"requirement-item"},Ne={class:"text-body-2"},je={class:"requirement-item"},Ge=b(()=>a("span",{class:"text-body-2"},"Formato: excel únicamente",-1)),Oe={class:"requirement-item"},Qe=b(()=>a("span",{class:"text-body-2"},"Solo se permite un archivo",-1)),He={key:0,class:"file-list mt-4"},Ke={class:"file-icon-section"},Je={class:"file-details"},Xe={class:"text-subtitle-1 font-weight-medium"},Ye={class:"text-body-2 text-medium-emphasis"},Ze={class:"file-actions"},We={key:1,class:"upload-progress-section"},es={class:"progress-header text-center mb-6"},ss={class:"text-h5 font-weight-medium"},ts={class:"progress-file-info"},as={class:"progress-file-icon"},os={class:"progress-details"},rs={class:"text-subtitle-1 font-weight-medium"},ls={class:"text-body-2 text-medium-emphasis"},is={class:"progress-section"},ns={class:"progress-info d-flex justify-space-between align-center mb-2"},cs={class:"text-body-1 font-weight-medium"},ds={key:1,class:"status-completed"},us=b(()=>a("span",{class:"text-success font-weight-medium"},"¡Archivo cargado exitosamente!",-1)),ps={key:2,class:"status-error"},ms={class:"text-error font-weight-medium"},fs=["accept"],_s=b(()=>a("h2",null,"¡Subida exitosa!",-1)),hs=b(()=>a("span",null,"El archivo excel se ha cargado correctamente.",-1)),vs=xe({__name:"ModalImportStudents",props:{maxFileSizeMB:{default:5},allowedExtensions:{default:()=>[".xlsx",".xls"]},maxFiles:{default:1}},setup(C,{expose:te}){const ae=be(),A=ye(),p=C,P=ke("accessToken").value,oe=Ce.create({baseURL:"https://back.colegiovirgendelvalle.com.co/api",headers:{"Content-Type":"multipart/form-data",Accept:"application/json",Authorization:`Bearer ${P}`}}),S=g(!1),k=g("upload"),n=g([]),z=g(!1),R=g(),re=s=>s<20?"Iniciando la carga del archivo excel...":s<40?"Verificando la integridad del archivo excel...":s<60?"Subiendo el archivo excel al servidor...":s<80?"Preparando los datos para la cola...":s<100?"Finalizando la carga del archivo...":"¡Carga completada! Los datos están listos para procesarse en la cola.",N=s=>s<30?"orange":s<70?"primary":"success",j=L(()=>n.value.length>0&&n.value.every(s=>s.status==="completed")),G=()=>Math.random().toString(36).substr(2,9),O=s=>{if(s===0)return"0 Bytes";const e=1024,t=["Bytes","KB","MB","GB"],f=Math.floor(Math.log(s)/Math.log(e));return parseFloat((s/Math.pow(e,f)).toFixed(2))+" "+t[f]},le=()=>p.maxFileSizeMB>0?`Límite de tamaño: ${p.maxFileSizeMB} MB`:"Tamaño de archivo ilimitado",ie=s=>{var e;if(p.maxFileSizeMB!==null){const t=p.maxFileSizeMB*1024*1024;if(s.size>t)return!1}if(p.allowedExtensions.length>0){const t="."+((e=s.name.split(".").pop())==null?void 0:e.toLowerCase());if(!p.allowedExtensions.includes(t||""))return!1}return!0},ne=s=>{var e;if(p.maxFileSizeMB>0){const t=p.maxFileSizeMB*1024*1024;if(s.size>t)return`El archivo excede el tamaño máximo de ${p.maxFileSizeMB} MB`}if(p.allowedExtensions.length>0){const t="."+((e=s.name.split(".").pop())==null?void 0:e.toLowerCase());if(!p.allowedExtensions.includes(t||""))return`Formato no válido. Use: ${p.allowedExtensions.join(", ")}`}return"Archivo no válido"},Q=s=>{const e=Array.from(s);n.value.length>0&&(n.value=[]);const t=e[0];if(!ie(t)){const o={id:G(),name:t.name,size:t.size,file:t,progress:0,status:"error",errorMessage:ne(t)};n.value.push(o);return}const f={id:G(),name:t.name,size:t.size,file:t,progress:0,status:"pending"};n.value.push(f)},ce=s=>{n.value=n.value.filter(e=>e.id!==s)},de=s=>{var e;s.preventDefault(),z.value=!1,(e=s.dataTransfer)!=null&&e.files&&Q(s.dataTransfer.files)},ue=()=>{var s;(s=R.value)==null||s.click()},pe=s=>{const e=s.target;e.files&&(Q(e.files),e.value="")},me=async()=>{k.value="uploading";const s=n.value.filter(t=>t.status==="pending"),e=async t=>{var o,D;const f=new FormData;f.append("file",t.file),f.append("company_id",String(A.company.id)),f.append("user_id",String(A.user.id));try{t.status="uploading",t.progress=0,t.errorMessage=void 0;const d=new XMLHttpRequest;t.xhr=d,await new Promise((he,T)=>{d.upload.addEventListener("progress",$=>{$.lengthComputable&&(t.progress=Math.round($.loaded*100/$.total))}),d.addEventListener("load",()=>{d.status>=200&&d.status<300?he(d.response):T(new Error(d.statusText))}),d.addEventListener("error",()=>{T(new Error("Error en la conexión"))}),d.addEventListener("abort",()=>{T(new Error("Subida cancelada"))}),d.open("POST",`${oe.defaults.baseURL}/students/uploadFileExcel`),d.setRequestHeader("Authorization",`Bearer ${P}`),d.setRequestHeader("Accept","application/json"),d.send(f)}),t.status="completed",t.progress=100;const Y=JSON.parse(d.response);Y.status=="success"&&ae.startLoading(Y.batch_id)}catch(d){d.message!=="Subida cancelada"&&(t.status="error",t.errorMessage=((D=(o=d.response)==null?void 0:o.data)==null?void 0:D.message)||"Error al subir el archivo")}finally{t.xhr=void 0}};for(const t of s)await e(t);j.value&&setTimeout(()=>{S.value=!0},500)},B=L(()=>n.value.some(s=>s.status==="uploading")),E=g(!1),H=async()=>{E.value=!0;try{const s=n.value.filter(e=>e.status==="uploading");await Promise.all(s.map(e=>{e.xhr&&e.xhr.abort()})),n.value.forEach(e=>{e.status!=="completed"&&(e.status="error",e.errorMessage="Subida cancelada por el usuario",e.xhr=void 0)}),V()}finally{E.value=!1}},fe=()=>{J()},K=()=>{S.value=!1},J=()=>{n.value=[],k.value="upload",z.value=!1},_e=L(()=>p.allowedExtensions.length>0?p.allowedExtensions.join(","):void 0),M=g(),X=()=>{const s=n.value.filter(e=>e.status==="completed").length;M.value.openModal(),M.value.componentData.title=s>0?`¿Cancelar subidas? ${s} archivo ya fue guardado`:"¿Está seguro que desea cancelar la subida?",M.value.componentData.actions=[{text:"Cancelar subida",color:"error",action:()=>H()},{text:"Continuar",color:"primary",action:()=>{}}].filter(Boolean)},w=g(!1),V=()=>{w.value=!w.value};return te({openModal:async()=>{V(),J()}}),(s,e)=>{const t=ge,f=ve;return c(),_(U,null,[l(se,{modelValue:u(w),"onUpdate:modelValue":e[5]||(e[5]=o=>Z(w)?w.value=o:null),overlay:!1,"max-width":"600px",transition:"dialog-transition",persistent:"",class:"upload-dialog"},{default:r(()=>[u(B)?(c(),x(t,{key:0,onClick:e[0]||(e[0]=o=>X())})):(c(),x(t,{key:1,onClick:e[1]||(e[1]=o=>V())})),l(q,{class:"upload-card",elevation:"12"},{default:r(()=>[a("div",null,[l(Me,{color:"primary"},{default:r(()=>[l(Ve,null,{default:r(()=>[l(m,{class:"mr-2"},{default:r(()=>[i("tabler-file-spreadsheet")]),_:1}),i(" Carga de archivo excel ")]),_:1})]),_:1})]),l(F,null,{default:r(()=>[u(k)==="upload"?(c(),_("div",De,[a("div",{ref:"dropzone",class:W(["modern-dropzone",{dragover:u(z)}]),onDrop:de,onDragover:e[2]||(e[2]=I(o=>z.value=!0,["prevent"])),onDragleave:e[3]||(e[3]=I(o=>z.value=!1,["prevent"])),onDragenter:e[4]||(e[4]=I(()=>{},["prevent"]))},[a("div",Te,[a("div",$e,[l(m,{size:"64",color:"primary"},{default:r(()=>[i("tabler-file-spreadsheet")]),_:1})]),Le,Ue,l(y,{color:"primary",variant:"elevated",size:"large",class:"upload-btn",onClick:ue},{default:r(()=>[l(m,{start:""},{default:r(()=>[i("tabler-folder-open")]),_:1}),i(" Seleccionar archivo ")]),_:1})])],34),a("div",Ie,[l(q,{variant:"tonal",color:"info",class:"pa-4"},{default:r(()=>[a("div",qe,[l(m,{color:"info",class:"mr-2"},{default:r(()=>[i("tabler-info-circle")]),_:1}),Ae]),a("div",Pe,[a("div",Re,[l(m,{size:"16",color:"success",class:"mr-2"},{default:r(()=>[i("tabler-check")]),_:1}),a("span",Ne,v(le()),1)]),a("div",je,[l(m,{size:"16",color:"success",class:"mr-2"},{default:r(()=>[i("tabler-check")]),_:1}),Ge]),a("div",Oe,[l(m,{size:"16",color:"success",class:"mr-2"},{default:r(()=>[i("tabler-check")]),_:1}),Qe])])]),_:1})]),u(n).length>0?(c(),_("div",He,[(c(!0),_(U,null,ee(u(n),o=>(c(),_("div",{key:o.id,class:"file-card"},[a("div",Ke,[l(m,{size:"40",color:o.status==="error"?"error":"primary"},{default:r(()=>[i(" tabler-file-spreadsheet ")]),_:2},1032,["color"])]),a("div",Je,[a("h4",Xe,v(o.name),1),a("p",Ye,v(O(o.size)),1),o.errorMessage?(c(),x(Fe,{key:0,type:"error",density:"compact",class:"mt-2"},{default:r(()=>[l(m,{start:""},{default:r(()=>[i("tabler-alert-triangle")]),_:1}),i(" "+v(o.errorMessage),1)]),_:2},1024)):h("",!0)]),a("div",Ze,[l(y,{icon:"tabler-x",size:"small",variant:"text",color:"error",onClick:D=>ce(o.id)},null,8,["onClick"])])]))),128))])):h("",!0)])):h("",!0),u(k)==="uploading"?(c(),_("div",We,[a("div",es,[a("h3",ss,[l(m,{start:"",color:"primary"},{default:r(()=>[i("tabler-upload")]),_:1}),i(" Cargando archivo excel ")])]),(c(!0),_(U,null,ee(u(n),o=>(c(),_("div",{key:o.id,class:"progress-card"},[a("div",ts,[a("div",as,[l(m,{size:"32",color:"primary"},{default:r(()=>[i("tabler-file-spreadsheet")]),_:1})]),a("div",os,[a("h4",rs,v(o.name),1),a("p",ls,v(O(o.size)),1)])]),a("div",is,[a("div",ns,[a("span",cs,v(re(o.progress)),1),a("span",{class:W(["text-h6 font-weight-bold",`text-${N(o.progress)}`])},v(o.progress)+"%",3)]),o.status==="uploading"?(c(),x(Se,{key:0,"model-value":o.progress,color:N(o.progress),height:"12",rounded:"",class:"progress-bar mb-3",striped:"",stream:!0},null,8,["model-value","color"])):h("",!0),o.status==="completed"?(c(),_("div",ds,[l(m,{color:"success",size:"24",class:"mr-2"},{default:r(()=>[i("tabler-circle-check")]),_:1}),us])):h("",!0),o.status==="error"?(c(),_("div",ps,[l(m,{color:"error",size:"24",class:"mr-2"},{default:r(()=>[i("tabler-alert-circle")]),_:1}),a("span",ms,v(o.errorMessage||"Error al cargar el archivo"),1)])):h("",!0)])]))),128))])):h("",!0)]),_:1}),l(Be),l(F,{class:"d-flex justify-end gap-3 flex-wrap"},{default:r(()=>[u(B)?(c(),x(y,{key:0,onClick:X,disabled:!u(B),loading:u(E)},{default:r(()=>[i(" Cancelar Subidas ")]),_:1},8,["disabled","loading"])):(c(),x(y,{key:1,onClick:V},{default:r(()=>[i(" Cancelar ")]),_:1})),u(k)==="upload"?(c(),x(y,{key:2,color:"primary",disabled:u(n).length===0,onClick:me},{default:r(()=>[i(" Guardar ")]),_:1},8,["disabled"])):h("",!0),u(k)==="uploading"?(c(),x(y,{key:3,color:"primary",disabled:!u(j),onClick:fe},{default:r(()=>[i(" Cargar nuevos archivos ")]),_:1},8,["disabled"])):h("",!0)]),_:1})]),_:1}),a("input",{ref_key:"fileInput",ref:R,type:"file",accept:u(_e),style:{display:"none"},onChange:pe},null,40,fs)]),_:1},8,["modelValue"]),l(se,{modelValue:u(S),"onUpdate:modelValue":e[7]||(e[7]=o=>Z(S)?S.value=o:null),"max-width":"500px"},{default:r(()=>[l(t,{onClick:e[6]||(e[6]=o=>K())}),l(q,null,{default:r(()=>[l(F,{class:"text-h5 text-center"},{default:r(()=>[l(m,{color:"success",size:"5rem",class:"mb-2"},{default:r(()=>[i("tabler-circle-check")]),_:1}),_s,hs]),_:1}),l(F,{class:"d-flex justify-center"},{default:r(()=>[l(y,{onClick:K},{default:r(()=>[i(" OK ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(f,{ref_key:"refModalQuestionCancelUpload",ref:M,onSuccess:H},null,512)],64)}}}),Ds=Ee(vs,[["__scopeId","data-v-2dd52e31"]]);export{Ds as default};
